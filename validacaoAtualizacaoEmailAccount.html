//author: Erick Vieira //date: 2024-06-26
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Documenta√ß√£o T√©cnica - Valida√ß√£o de Email em Account</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <a href="index.html" target="_blank">üìò Home</a>
    <h1>Home</h1>
    <h2>Valida√ß√£o de Atualiza√ß√£o de Email em Account</h2>

    <div class="section">
      <h3>üéØ Objetivo</h3>
      <p>
        Impedir a atualiza√ß√£o do campo <code>Email__c</code> em registros do
        objeto <strong>Account</strong> caso n√£o existam
        <strong>Contatos relacionados</strong>. A opera√ß√£o deve ser bloqueada
        com uma mensagem de erro amig√°vel.
      </p>
    </div>

    <div class="section">
      <h3>üß† Conceitos Aplicados</h3>
      <ul>
        <li>
          <strong>Observer Pattern</strong>: Observa altera√ß√µes no campo
          <code>Email__c</code> e aciona a l√≥gica de valida√ß√£o.
        </li>
        <li>
          <strong>Strategy Pattern</strong>: Encapsula a l√≥gica de valida√ß√£o,
          permitindo flexibilidade e reutiliza√ß√£o.
        </li>
        <li>
          <strong>Trigger Handler Pattern</strong>: Centraliza o controle da
          trigger em uma classe externa, promovendo organiza√ß√£o e testabilidade.
        </li>
      </ul>
    </div>

    <div class="section">
      <h3>üèóÔ∏è Estrutura do C√≥digo</h3>

      <h4>1. Trigger: <code>DSP_Account</code></h4>
      <pre><code>trigger DSP_Account on Account (before insert, before update) {
    new DSP_AccountTriggerHandler(Trigger.new, Trigger.oldMap, Trigger.isInsert, Trigger.isUpdate).run();
}</code></pre>

      <h4>2. Trigger Handler: <code>DSP_AccountTriggerHandler</code></h4>
      <pre><code>public class DSP_AccountTriggerHandler {
    public void run() {
        if (isUpdate) {
            EPFV_AccountEmailObserver.handle(newList, oldMap);
        }
    }
}</code></pre>

      <h4>3. Observer: <code>EPFV_AccountEmailObserver</code></h4>
      <pre><code>public class EPFV_AccountEmailObserver {
    public static void handle(List&lt;Account&gt; newList, Map&lt;Id, Account&gt; oldMap) {
        List&lt;Account&gt; changedAccounts = new List&lt;Account&gt;();
        for (Account acc : newList) {
            Account oldAcc = oldMap.get(acc.Id);
            if (acc.Email__c != oldAcc.Email__c) {
                changedAccounts.add(acc);
            }
        }
        new EPFV_ContactExistenceValidator().validate(changedAccounts);
    }
}</code></pre>

      <h4>
        4. Interface Strategy: <code>EPFV_AccountValidationStrategy</code>
      </h4>
      <pre><code>public interface EPFV_AccountValidationStrategy {
    void validate(List&lt;Account&gt; accounts);
}</code></pre>

      <h4>5. Implementa√ß√£o: <code>EPFV_ContactExistenceValidator</code></h4>
      <pre><code>public class EPFV_ContactExistenceValidator implements EPFV_AccountValidationStrategy {
    public void validate(List&lt;Account&gt; accounts) {
        Set&lt;Id&gt; accountIds = new Set&lt;Id&gt;();
        for (Account acc : accounts) {
            accountIds.add(acc.Id);
        }

        Map&lt;Id, List&lt;Contact&gt;&gt; contactsByAccount = new Map&lt;Id, List&lt;Contact&gt;&gt;();
        for (Contact c : [SELECT Id, AccountId FROM Contact WHERE AccountId IN :accountIds]) {
            if (!contactsByAccount.containsKey(c.AccountId)) {
                contactsByAccount.put(c.AccountId, new List&lt;Contact&gt;());
            }
            contactsByAccount.get(c.AccountId).add(c);
        }

        for (Account acc : accounts) {
            if (!contactsByAccount.containsKey(acc.Id)) {
                acc.Email__c.addError('N√£o √© poss√≠vel atualizar o Email__c sem contatos relacionados.');
            }
        }
    }
}</code></pre>
    </div>

    <div class="section">
      <h3>üìå Fluxo de Execu√ß√£o</h3>
      <ol>
        <li>A trigger √© acionada no <code>before update</code>.</li>
        <li>O handler verifica se √© uma atualiza√ß√£o e chama o Observer.</li>
        <li>O Observer detecta altera√ß√µes no campo <code>Email__c</code>.</li>
        <li>A Strategy √© acionada para validar se h√° contatos.</li>
        <li>
          Se n√£o houver, a atualiza√ß√£o √© bloqueada com <code>addError()</code>.
        </li>
      </ol>
    </div>

    <div class="section">
      <h3>üß™ Sugest√µes Futuras</h3>
      <ul>
        <li>Criar testes unit√°rios com <code>@isTest</code>.</li>
        <li>Expandir a l√≥gica para outros campos ou objetos.</li>
        <li>Adicionar logs para auditoria.</li>
      </ul>
    </div>
  </body>
</html>
